<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­">
    <meta name="theme-color" content="#f97316">
    <title>ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - Ù…Ø·Ø¹Ù…ÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/client-premium.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœ…</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        /* Success Page Specific Styles */
        .success-bg {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #fffdf8 0%, #fff7ed 40%, #ffedd5 100%);
            z-index: -1;
        }
        
        .success-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: radial-gradient(ellipse at 50% 0%, rgba(249,115,22,0.08) 0%, transparent 70%);
        }
        
        .success-bg::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: radial-gradient(ellipse at 50% 100%, rgba(34,197,94,0.05) 0%, transparent 70%);
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            animation: confetti-fall 4s linear forwards;
            z-index: 0;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .map-container {
            height: 250px;
            border-radius: var(--cp-radius-lg);
            overflow: hidden;
            border: 2px solid var(--cp-gray-200);
            margin-top: 20px;
        }
        
        #trackingMap {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="cp-page">
    <!-- Background -->
    <div class="success-bg"></div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-icon rocket-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="currentColor">
                           <path class="rocket-body" d="M12 2.5s-6 6.5-6 11c0 3 2.5 5.5 6 5.5s6-2.5 6-5.5c0-4.5-6-11-6-11z" fill="#E0E0E0"/>
                           <path class="rocket-window" d="M12 9a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" fill="#3B82F6"/>
                           <path class="rocket-fins" d="M5.5 14L2 19h5l1-2.5M18.5 14L22 19h-5l-1-2.5" fill="#FF5722"/>
                           <path class="rocket-fire" d="M12 20s-1.5 1.5-1.5 3 .5 1 1.5 1 1.5.5 1.5-1-1.5-3-1.5-3z" fill="#FFC107"/>
                        </svg>
                    </span>
                    <span id="logoName"></span>
                </a>
            </div>
        </div>
    </header>

    <!-- Success Page -->
    <main class="cp-main" style="padding-top: 100px;">
        <div class="cp-container">
            <!-- Success Header -->
            <div class="cp-success-header cp-fade-in">
                <div class="cp-success-icon">ğŸ‰</div>
                <h1 class="cp-success-title">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</h1>
                <p class="cp-success-subtitle">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§! Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù† ÙÙŠ Ø£ÙŠØ¯Ù Ø£Ù…ÙŠÙ†Ø© ÙˆØ³ÙŠØµÙ„Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.</p>
            </div>

            <div class="cp-grid cp-fade-in cp-delay-1">
                <!-- Right Column: Status & Actions -->
                <div>
                    <!-- Order Number Banner -->
                    <div class="cp-order-banner">
                        <div>
                            <span class="cp-order-banner-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span>
                            <h2 id="orderNumber" class="cp-order-banner-number">---</h2>
                        </div>
                        <button class="cp-btn cp-btn-secondary" onclick="copyOrderNumber()" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            Ù†Ø³Ø®
                        </button>
                    </div>

                    <!-- Status Tracker -->
                    <div class="cp-status-tracker cp-fade-in cp-delay-2">
                        <div class="cp-status-header">
                            <h3>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--cp-orange-500)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨
                            </h3>
                            <span class="cp-live-badge">
                                <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block;"></span>
                                Ù…Ø¨Ø§Ø´Ø±
                            </span>
                        </div>
                        
                        <div class="cp-status-steps" id="orderStatusSteps">
                            <div class="cp-status-step active completed">
                                <div class="cp-step-line"></div>
                                <div class="cp-step-icon">ğŸ“</div>
                                <div class="cp-step-content">
                                    <h4>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h4>
                                    <p>Ø·Ù„Ø¨Ùƒ ÙˆØµÙ„ Ù„Ù„Ù…Ø·Ø¹Ù…</p>
                                </div>
                                <div class="cp-step-check">âœ“</div>
                            </div>
                            <div class="cp-status-step active">
                                <div class="cp-step-line"></div>
                                <div class="cp-step-icon">ğŸ‘¨â€ğŸ³</div>
                                <div class="cp-step-content">
                                    <h4>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</h4>
                                    <p>ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø´ÙŠÙ Ø¨ØªØ¬Ù‡ÙŠØ² ÙˆØ¬Ø¨ØªÙƒ</p>
                                </div>
                                <div class="cp-step-check">âœ“</div>
                            </div>
                            <div class="cp-status-step">
                                <div class="cp-step-line"></div>
                                <div class="cp-step-icon">ğŸ“¦</div>
                                <div class="cp-step-content">
                                    <h4>Ø¬Ø§Ù‡Ø²</h4>
                                    <p>ÙˆØ¬Ø¨ØªÙƒ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ…</p>
                                </div>
                            </div>
                            <div class="cp-status-step" id="deliveryStep">
                                <div class="cp-step-line"></div>
                                <div class="cp-step-icon">ğŸ›µ</div>
                                <div class="cp-step-content">
                                    <h4>ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</h4>
                                    <p>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ</p>
                                </div>
                            </div>
                            <div class="cp-status-step">
                                <div class="cp-step-icon">ğŸ‰</div>
                                <div class="cp-step-content">
                                    <h4>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</h4>
                                    <p>Ø¨Ø§Ù„Ù‡Ù†Ø§Ø¡ ÙˆØ§Ù„Ø´ÙØ§Ø¡!</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Map for delivery -->
                        <div class="map-container" id="trackingMapContainer" style="display: none;">
                            <div id="trackingMap"></div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 24px;" class="cp-fade-in cp-delay-3">
                        <a href="my-orders.html" class="cp-btn cp-btn-primary cp-btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                            Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§ØªÙŠ
                        </a>
                        <a href="index.html" class="cp-btn cp-btn-secondary cp-btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            Ø·Ù„Ø¨ Ø¢Ø®Ø±
                        </a>
                    </div>
                </div>

                <!-- Left Column: Receipt Visual -->
                <div class="cp-fade-in cp-delay-2">
                    <div class="cp-receipt">
                        <div class="cp-receipt-header">
                            <div class="cp-receipt-logo">ğŸ”</div>
                            <h3>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
                        </div>
                        <div id="orderDetails" class="cp-receipt-body">
                            <!-- JS creates structure -->
                        </div>
                        <div class="cp-receipt-footer">
                            <div class="cp-barcode">||| |||| || ||||| ||||</div>
                            <p style="margin: 0; color: var(--cp-gray-500); font-size: 0.85rem;">Ø§Ø­ØªÙØ¸ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script>window.SKIP_AUTO_INIT = true;</script>
    <script src="js/api-client.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        let map = null;

        // Create confetti effect
        function createConfetti() {
            const colors = ['#f97316', '#fbbf24', '#22c55e', '#3b82f6', '#ec4899'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (3 + Math.random() * 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 5000);
                }, i * 50);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
             // Create confetti effect
             createConfetti();
             
             // Update Restaurant Info
             const cachedSettings = getSettings(); 
             if (cachedSettings && cachedSettings.restaurantName) {
                 document.getElementById('logoName').textContent = cachedSettings.restaurantName;
                 document.title = `ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - ${cachedSettings.restaurantName}`;
             }

             initializeData({ settings: true }).then(() => {
                 const settings = getSettings();
                 if (settings && settings.restaurantName) {
                     document.getElementById('logoName').textContent = settings.restaurantName;
                     document.title = `ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - ${settings.restaurantName}`;
                 }
             });

             const orderNumber = sessionStorage.getItem('lastOrderNumber');
             const orderId = sessionStorage.getItem('lastOrderId');
             const storedDetails = sessionStorage.getItem('lastOrderDetails');
             
             if (!orderNumber && !orderId && !storedDetails) {
                 window.location.href = 'index.html';
                 return;
             }
             
             let order = null;
             
             if (storedDetails) {
                 try {
                     order = JSON.parse(storedDetails);
                     console.log("Loaded order from Session Storage:", order);
                 } catch(e) {
                     console.error("Failed to parse stored details", e);
                 }
             }

             if (!order) {
                 try {
                    const targetId = orderId || orderNumber; 
                    
                    const response = await ApiClient.request(`/orders?id=${targetId}`);
                    
                    if (Array.isArray(response)) {
                        order = response.find(o => o.id == targetId || o.orderNumber == orderNumber);
                        if (!order && response.length === 1) order = response[0];
                    } else if (response && (response.id || response.orderNumber)) {
                         order = response;
                    }
                    
                    if (order) {
                         if (!order.items) order.items = [];
                         if (typeof order.location === 'string' && order.location.startsWith('{')) {
                             try { order.location = JSON.parse(order.location); } catch(e){}
                         }
                    }
    
                 } catch (e) {
                     console.error("Order fetch failed, trying fallback", e);
                 }
             }

             if (order) {
                 document.getElementById('orderNumber').textContent = order.orderNumber || order.id || '---';
                 renderOrderDetails(order);
                 updateStatusTracker(order.status);
                 
                 if (order.orderType === 'delivery') {
                     document.getElementById('deliveryStep').style.display = 'flex';
                     
                     if (order.location && order.location.lat && order.location.lng) {
                          document.getElementById('trackingMapContainer').style.display = 'block';
                          setTimeout(() => initTrackingMap(order.location.lat, order.location.lng), 500);
                     }
                 } else {
                     document.getElementById('deliveryStep').style.display = 'none';
                 }
             } else {
                 showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨', 'error');
                 setTimeout(() => window.location.href = 'index.html', 3000);
             }
        });

        function initTrackingMap(lat, lng) {
            if (map) return;
            
            map = L.map('trackingMap').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            
            // Custom orange marker
            const userIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            L.marker([lat, lng], { icon: userIcon }).addTo(map)
                .bindPopup('ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„')
                .openPopup();
                
            // Driver marker
            const driverLat = parseFloat(lat) + 0.004;
            const driverLng = parseFloat(lng) + 0.004;
            
            const driverIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/7541/7541900.png',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            
            L.marker([driverLat, driverLng], {icon: driverIcon}).addTo(map)
                .bindPopup('ğŸ›µ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨');
                
            setTimeout(() => map.invalidateSize(), 300);
        }
        
        function renderOrderDetails(order) {
            const container = document.getElementById('orderDetails');
            
            container.innerHTML = `
                <div style="padding-bottom: 16px; margin-bottom: 16px; border-bottom: 2px solid var(--cp-gray-100);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1rem;">ğŸ‘¤ ${order.customerName}</strong><br>
                            <span style="color: var(--cp-gray-500); font-size: 0.9rem;">ğŸ“± ${order.customerPhone}</span>
                        </div>
                        <span style="background: var(--cp-gray-100); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            ${order.orderType === 'delivery' ? 'ğŸ›µ ØªÙˆØµÙŠÙ„' : 'ğŸ½ï¸ Ø­Ø¶ÙˆØ±'}
                        </span>
                    </div>
                </div>
                
                <div>
                    ${order.items.map(item => `
                        <div class="cp-receipt-item">
                            <span>${item.quantity}x ${item.name} ${item.sizeName ? `(${item.sizeName})` : ''}</span>
                            <span style="font-weight: 700;">${formatPrice(item.price * item.quantity)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 20px; padding-top: 16px; border-top: 2px dashed var(--cp-gray-200);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--cp-gray-600);">
                        <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
                        <span>${formatPrice(order.subtotal)}</span>
                    </div>
                    ${order.orderType === 'delivery' ? `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--cp-gray-600);">
                        <span>Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
                        <span>${order.deliveryCost > 0 ? formatPrice(order.deliveryCost) : 'Ù…Ø¬Ø§Ù†ÙŠ'}</span>
                    </div>
                    ` : ''}
                    <div class="cp-receipt-total">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                        <span>${formatPrice(order.total)}</span>
                    </div>
                </div>
            `;
        }

        function updateStatusTracker(currentStatus) {
            const steps = document.querySelectorAll('.cp-status-step');
            steps.forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            let activeIndex = 0;
            if (currentStatus === 'preparing') activeIndex = 1;
            if (currentStatus === 'ready') activeIndex = 2;
            if (currentStatus === 'onTheWay' || currentStatus === 'delivery') activeIndex = 3;
            if (currentStatus === 'delivered') activeIndex = 4;
            
            steps.forEach((step, index) => {
                if (index < activeIndex) {
                    step.classList.add('active', 'completed');
                    if(!step.querySelector('.cp-step-check')) {
                        const check = document.createElement('div');
                        check.className = 'cp-step-check';
                        check.textContent = 'âœ“';
                        step.appendChild(check);
                    }
                } else if (index === activeIndex) {
                    step.classList.add('active');
                }
            });
        }
        
        function copyOrderNumber() {
            const orderNumber = document.getElementById('orderNumber').textContent;
            if (typeof copyToClipboard === 'function') {
                copyToClipboard(orderNumber);
            } else {
                navigator.clipboard.writeText(orderNumber);
                showToast('ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'success');
            }
        }
    </script>
</body>
</html>
