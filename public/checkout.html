<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ø£ÙƒÙ…Ù„ Ø·Ù„Ø¨Ùƒ - Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨">
    <meta name="theme-color" content="#f97316">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - Ù…Ø·Ø¹Ù…ÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
</head>


<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-icon rocket-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="currentColor">
                           <path class="rocket-body" d="M12 2.5s-6 6.5-6 11c0 3 2.5 5.5 6 5.5s6-2.5 6-5.5c0-4.5-6-11-6-11z" fill="#E0E0E0"/>
                           <path class="rocket-window" d="M12 9a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" fill="#3B82F6"/>
                           <path class="rocket-fins" d="M5.5 14L2 19h5l1-2.5M18.5 14L22 19h-5l-1-2.5" fill="#FF5722"/>
                           <path class="rocket-fire" d="M12 20s-1.5 1.5-1.5 3 .5 1 1.5 1 1.5.5 1.5-1-1.5-3-1.5-3z" fill="#FFC107"/>
                        </svg>
                    </span>
                    <span id="logoName"></span>
                </a>
                
                <div class="header-actions">
                    <a href="cart.html" class="btn btn-secondary">
                        <span style="display:flex; align-items:center;">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                        </span>
                        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ù„Ø©</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Checkout Page -->
    <main class="cart-page">
        <div class="container">
            <h1 class="fade-in" style="margin-bottom: 2rem;">
                <span style="display:inline-flex; align-items:center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                </span> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
            </h1>
            
            <div class="checkout-grid">
                <!-- Checkout Form -->
                <div>
                    <form id="checkoutForm" onsubmit="handleCheckout(event)">
                        <!-- Customer Info -->
                        <div class="checkout-section fade-in fade-in-delay-1">
                            <h3 class="section-title">
                                <span style="display:inline-flex; align-items:center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <circle cx="12" cy="8" r="4" fill="#60A5FA"/>
                                        <path d="M20 21C20 16.5817 16.4183 13 12 13C7.58172 13 4 16.5817 4 21" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </span> Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                                <input type="text" class="form-input" id="customerName" required 
                                       placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                                <input type="tel" class="form-input" id="customerPhone" required 
                                       placeholder="05XX XXX XXX" pattern="0[5-7][0-9]{8}"
                                       style="direction: ltr; text-align: right;">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</small>
                            </div>
                        </div>
                        
                        <!-- Order Type -->
                        <div class="checkout-section fade-in fade-in-delay-2">
                            <h3 class="section-title">
                                <span style="display:inline-flex; align-items:center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <rect x="3" y="4" width="18" height="16" rx="2" fill="#FCD34D" stroke="#F59E0B" stroke-width="2"/>
                                        <path d="M8 9H16" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M8 13H16" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M8 17H12" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </span> Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
                            </h3>
                            
                            <div class="radio-cards">
                                <label class="radio-card selected" id="deliveryCard">
                                    <input type="radio" name="orderType" value="delivery" checked 
                                           onchange="toggleOrderType('delivery')">
                                    <div class="radio-card-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 64 64" fill="none">
                                            <!-- Road/Shadow -->
                                            <path d="M4 56 H60" stroke="#E5E7EB" stroke-width="2" stroke-linecap="round"/>
                                            
                                            <!-- Back Wheel -->
                                            <circle cx="14" cy="48" r="7" fill="#374151" stroke="#1F2937" stroke-width="2"/>
                                            <circle cx="14" cy="48" r="3" fill="#9CA3AF"/>
                                            
                                            <!-- Front Wheel -->
                                            <circle cx="50" cy="48" r="7" fill="#374151" stroke="#1F2937" stroke-width="2"/>
                                            <circle cx="50" cy="48" r="3" fill="#9CA3AF"/>
                                            
                                            <!-- Bike Frame Body -->
                                            <path d="M14 48 L22 30 H40 L46 48" fill="#EF4444" stroke="#B91C1C" stroke-width="2" stroke-linejoin="round"/>
                                            <path d="M22 30 L18 20" stroke="#374151" stroke-width="3" stroke-linecap="round"/> <!-- Handlebar stem towards back a bit? No, fork. -->
                                            <path d="M50 48 L44 26 L40 22 H48" stroke="#374151" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/> <!-- Handlebars -->
                                            
                                            <!-- Seat -->
                                            <path d="M20 30 H32" stroke="#1F2937" stroke-width="4" stroke-linecap="round"/>
                                            
                                            <!-- Rear Basket (Wire style) -->
                                            <path d="M6 30 H18 L16 40 H8 Z" fill="none" stroke="#D97706" stroke-width="2"/>
                                            <path d="M8 30 L9 40 M11 30 L11 40 M13 30 L13 40 M15 30 L15 40" stroke="#D97706" stroke-width="1"/>
                                            <path d="M6 33 H17 M7 37 H16" stroke="#D97706" stroke-width="1"/>
                                            
                                            <!-- Food in Basket -->
                                            <circle cx="10" cy="26" r="3" fill="#FCD34D" stroke="#D97706" stroke-width="1"/>
                                            <path d="M13 22 L15 30" stroke="#10B981" stroke-width="2"/> <!-- Baguette/Greens? -->
                                            
                                            <!-- Headlight beam -->
                                            <path d="M48 24 L56 26" stroke="#FEF3C7" stroke-width="2" stroke-dasharray="2 2"/>
                                        </svg>
                                    </div>
                                    <div class="radio-card-title">ØªÙˆØµÙŠÙ„</div>
                                    <div class="radio-card-desc">Ù†ÙˆØµÙ„Ùƒ Ù„Ù„Ø¨Ø§Ø¨</div>
                                </label>
                                
                                <label class="radio-card" id="dineInCard">
                                    <input type="radio" name="orderType" value="dineIn" 
                                           onchange="toggleOrderType('dineIn')">
                                    <div class="radio-card-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none">
                                            <!-- Tray -->
                                            <rect x="2" y="18" width="20" height="2" rx="1" fill="#9CA3AF"/>
                                            <!-- Drink -->
                                            <path d="M16 11H20L19 17H17L16 11Z" fill="#3B82F6" opacity="0.8"/>
                                            <line x1="18" y1="9" x2="19" y2="13" stroke="#F87171" stroke-width="1.5" stroke-linecap="round"/>
                                            <!-- Covered Meal (Dome) -->
                                            <path d="M4 17H14V16C14 12 12 9 9 9C6 9 4 12 4 16V17Z" fill="#FCD34D" stroke="#F59E0B" stroke-width="1.5"/>
                                            <circle cx="9" cy="8" r="1" fill="#F59E0B"/>
                                            <!-- Plate line -->
                                            <line x1="4" y1="17" x2="14" y2="17" stroke="#B45309" stroke-width="1.5"/>
                                        </svg>
                                    </div>
                                    <div class="radio-card-title">Ø­Ø¶ÙˆØ±</div>
                                    <div class="radio-card-desc">ØªØ£ÙƒÙ„ Ø¹Ù†Ø¯Ù†Ø§</div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Delivery Address -->
                        <div id="addressSection" class="checkout-section fade-in fade-in-delay-2">
                            <h3 class="section-title">
                                <span style="display:inline-flex; align-items:center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 5.02944 7.02944 1 12 1C16.9706 1 21 5.02944 21 10Z" fill="#34D399" stroke="#059669" stroke-width="2"/>
                                        <circle cx="12" cy="10" r="3" fill="white"/>
                                    </svg>
                                </span> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„
                            </h3>
                            
                            <!-- Location Buttons & Map -->
                            <!-- Map Container -->
                            <div class="map-wrapper" style="position: relative; margin-bottom: 1rem;">
                                <div id="mapLoader" class="map-loading-overlay">
                                    <div class="spinner"></div>
                                    <span style="margin-top: 10px; font-weight: 600;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...</span>
                                </div>
                                <div id="mapContainer" class="map-container"></div>
                            </div>
                        
                            <!-- Location Actions -->
                            <h4 style="font-size: 0.95rem; margin-bottom: 0.75rem; color: var(--text-muted);">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</h4>
                            <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" onclick="getMyLocation()">
                                    <span style="display:inline-flex; align-items:center;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                                    </span> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ (GPS)
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearLocation()">
                                    <span style="display:inline-flex; align-items:center;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </span> Ù…Ø³Ø­
                                </button>
                            </div>

                            <!-- Manual Address Description (Optional for Delivery) -->
                            <div class="form-group">
                                <label class="form-label" style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.5rem; display: block;">ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <textarea class="form-textarea" id="address"
                                          placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ù…Ø³Ø¬Ø¯ Ø§Ù„ØªÙ‚ÙˆÙ‰ØŒ Ø§Ù„Ù…Ù†Ø²Ù„ Ø±Ù‚Ù… 15ØŒ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ..." rows="3"
                                          style="font-family: inherit; font-size: 1rem; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; width: 100%; transition: all 0.2s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.05);"></textarea>
                                <small style="display:block; margin-top:0.5rem; color:var(--text-muted); font-size: 0.85rem;">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).</small>
                            </div>
                            
                            <input type="hidden" id="locationLat">
                            <input type="hidden" id="locationLng">
                            <input type="hidden" id="locationName">
                        </div>
                        
                        <!-- Scheduled Time -->

                        
                        <!-- Notes -->
                        <div class="checkout-section fade-in fade-in-delay-3">
                            <h3 class="section-title">
                                <span style="display:inline-flex; align-items:center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#FDE68A" stroke="#F59E0B" stroke-width="2"/>
                                        <path d="M7 12H17" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M7 8H13" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M7 16H15" stroke="#B45309" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </span> Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                            </h3>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <textarea class="form-textarea" id="notes" rows="3"
                                          placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ù„Ø¨..."></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg btn-block fade-in fade-in-delay-3">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ“
                        </button>
                    </form>
                </div>
                
                <!-- Order Summary -->
                <div>
                    <div class="cart-summary fade-in fade-in-delay-2">
                        <h3 style="margin-bottom: 1.5rem;">
                             <span style="display:inline-flex; align-items:center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" fill="white" stroke="#64748B" stroke-width="2"/>
                                    <path d="M7 7H17" stroke="#EF4444" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M7 12H17" stroke="#64748B" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M7 17H12" stroke="#64748B" stroke-width="2" stroke-linecap="round"/>
                                    <circle cx="16.5" cy="17.5" r="2.5" fill="#3B82F6"/>
                                </svg>
                            </span> Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨
                        </h3>
                        
                        <div id="checkoutItems" style="margin-bottom: 1.5rem;">
                            <!-- Items will be loaded here -->
                        </div>
                        
                        <div class="summary-row">
                            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
                            <span id="checkoutSubtotal">0 Ø¯Ø¬</span>
                        </div>
                        <div class="summary-row" id="deliveryRow">
                            <span>Ø§Ù„ØªÙˆØµÙŠÙ„</span>
                            <span id="checkoutDelivery">0 Ø¯Ø¬</span>
                        </div>
                        <div class="summary-row">
                            <span style="font-weight: 700; font-size: 1.1rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                            <span class="summary-total" id="checkoutTotal">0 Ø¯Ø¬</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/api-client.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/orders.js"></script>
    <script>
        // Render Items in Checkout
        function renderCheckoutItems() {
            const container = document.getElementById('checkoutItems');
            const cart = getCart();
            
            if (cart.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted);">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
                return;
            }
            
            container.innerHTML = cart.map((item, index) => `
                <div class="fade-in" style="animation-delay: ${index * 0.05}s; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed rgba(0,0,0,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="position: relative;">
                            ${window.getMealImageOrPlaceholder 
                                ? window.getMealImageOrPlaceholder(item, 'width: 50px; height: 50px; border-radius: 8px;', 'width: 50px; height: 50px; border-radius: 8px; object-fit: cover;') 
                                : (item.image 
                                    ? `<img src="${item.image}" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover;">` 
                                    : `<img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f37d.svg" style="width: 50px; height: 50px;">`
                                )
                            }
                            <span style="position: absolute; -top: -5px; -right: -5px; background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">${item.quantity}</span>
                        </div>
                        <div>
                            <div style="font-weight: 600; font-size: 0.95rem;">${item.name}</div>
                            ${item.sizeName ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${item.sizeName}</div>` : ''}
                        </div>
                    </div>
                    <div style="font-weight: 700;">${formatPrice(item.price * item.quantity)}</div>
                </div>
            `).join('');
        }
        
        // Update Summary
        function updateCheckoutSummary() {
            const subtotal = getCartTotal();
            const orderTypeInput = document.querySelector('input[name="orderType"]:checked');
            const orderType = orderTypeInput ? orderTypeInput.value : 'delivery';
            const settings = getSettings();
            
            let deliveryText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            let deliveryCost = 0;
            const deliveryRow = document.getElementById('deliveryRow');
            
            if (orderType === 'dineIn') {
                deliveryCost = 0;
                if(deliveryRow) deliveryRow.style.display = 'none';
                const addrSec = document.getElementById('addressSection');
                if(addrSec) addrSec.style.display = 'none';
            } else {
                if(deliveryRow) deliveryRow.style.display = 'flex';
                const addrSec = document.getElementById('addressSection');
                if(addrSec) addrSec.style.display = 'block';
                
                // Calculate Delivery
                const deliverySettings = settings.delivery;
                
                if (deliverySettings && deliverySettings.enabled) {
                    if (deliverySettings.type === 'fixed') {
                        // Fixed price
                        deliveryCost = deliverySettings.fixedCost || 0;
                        if (deliveryCost === 0) {
                            // If explicit 0, treat as free if intended, but here safe to show price
                            deliveryText = formatPrice(0);
                        } else {
                            deliveryText = formatPrice(deliveryCost);
                        }
                    } else if (deliverySettings.type === 'free') {
                        deliveryCost = 0;
                        deliveryText = 'Ù…Ø¬Ø§Ù†ÙŠ';
                    } else {
                        // not_specified
                        deliveryCost = 0; 
                        deliveryText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    }
                } else {
                    // Disabled or missing
                    deliveryText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    deliveryCost = 0;
                }
            }
            
            const subElem = document.getElementById('checkoutSubtotal');
            if(subElem) subElem.textContent = formatPrice(subtotal);
            
            const delElem = document.getElementById('checkoutDelivery');
            if(delElem) delElem.textContent = deliveryText;
            
            // If delivery is 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' and cost is 0, total should perhaps reflect uncertainty?
            // current logic: subtotal + 0.
            const totalElem = document.getElementById('checkoutTotal');
            if(totalElem) totalElem.textContent = formatPrice(subtotal + deliveryCost);
        }
        
        function toggleOrderType(type) {
             const deliveryCard = document.getElementById('deliveryCard');
             const dineInCard = document.getElementById('dineInCard');
             
             if (type === 'delivery') {
                 deliveryCard.classList.add('selected');
                 dineInCard.classList.remove('selected');
             } else {
                 dineInCard.classList.add('selected');
                 deliveryCard.classList.remove('selected');
             }
             updateCheckoutSummary();
        }

        // Map variables
        let map = null;
        let marker = null;
        let userLocation = null;
        let accuracyCircle = null;
        
        // Default location (Algeria - Algiers)
        const defaultLat = 36.7538;
        const defaultLng = 3.0588;
        
        document.addEventListener('DOMContentLoaded', async () => {
             // ... existing initialization logic ...
            const cart = getCart();
            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }

            // 0. Update Restaurant Info (Logo & Name) - FAST LOAD
            try {
                // Try global getSettings first (if loaded from data.js)
                if (typeof getSettings === 'function') {
                    const cached = getSettings();
                    if (cached && cached.restaurantName) {
                        const logoElement = document.getElementById('logoName');
                        if (logoElement) logoElement.textContent = cached.restaurantName;
                    }
                } else {
                    // Fallback to manual local storage read if data.js isn't ready
                    const manualCache = JSON.parse(localStorage.getItem('cachedSettings') || '{}');
                    if (manualCache.restaurantName) {
                        const logoElement = document.getElementById('logoName');
                        if (logoElement) logoElement.textContent = manualCache.restaurantName;
                    }
                }
            } catch(e) { console.error("Fast load error", e); }

            if (typeof initializeData === 'function') {
                await initializeData(); // Wait for fresh data
                const settings = getSettings();
                if (settings.restaurantName) {
                     const logoName = document.getElementById('logoName');
                     if (logoName) logoName.textContent = settings.restaurantName;
                }
            }

            renderCheckoutItems();
            updateCheckoutSummary();
            
            // Initialize Map
            // Initialize Map with Safety Check
            // Optimized Map Initialization
            // Initialize Map safely
            const initMapSafely = () => {
                const loader = document.getElementById('mapLoader');
                if (map) { 
                    if(loader) loader.style.display = 'none';
                    return; 
                }

                try {
                    if (typeof L === 'undefined') {
                        setTimeout(initMapSafely, 500); // Wait a bit longer
                        return;
                    }
                    
                    // Delay slightly to ensure container is rendered
                    setTimeout(() => {
                        initMap();
                        // Fix for grey tiles: force map to check its size
                        if (map) {
                             setTimeout(() => { map.invalidateSize(); }, 200);
                        }
                    }, 100);
                    
                } catch (e) {
                    console.error("Map Init Error", e);
                } finally {
                    // Safe hide
                    setTimeout(() => {
                        if(loader) loader.style.display = 'none';
                    }, 1500);
                }
            };

            // Initialize on window load to be sure styles are applied
            window.addEventListener('load', initMapSafely);
            
            // Backup
            setTimeout(initMapSafely, 1000);
            
            document.addEventListener('data-ready', updateCheckoutSummary);
        });
        
        function initMap() {
            map = L.map('mapContainer').setView([defaultLat, defaultLng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            // Click to set location manually
            map.on('click', function(e) {
                setMapLocation(e.latlng.lat, e.latlng.lng);
            });
            
            showToast('ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)', 'info');
        }

        // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¨Ø§Ù„Ù…ØªØ±)
        let currentLocationAccuracy = null;

        function setMapLocation(lat, lng, updateInputs = true) {
            if (updateInputs) {
                document.getElementById('locationLat').value = lat;
                document.getElementById('locationLng').value = lng;
                // Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ«Ø¨ÙŠØª)ØŒ Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø© (0 Ù…ØªØ±)
                currentLocationAccuracy = 0;
            }
            userLocation = { lat, lng };
            
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                const userIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                marker = L.marker([lat, lng], { draggable: true, icon: userIcon }).addTo(map);
                marker.bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
                
                marker.on('dragend', function(e) {
                    const pos = marker.getLatLng();
                    // Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ù‚ÙŠÙ… ÙˆÙ†Ø¹ØªØ¨Ø± Ø§Ù„Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø©
                    setMapLocation(pos.lat, pos.lng, true);
                });
            }
            
            map.setView([lat, lng], 16);
            updateCheckoutSummary(); 
        }

        function clearLocation() {
            document.getElementById('locationLat').value = '';
            document.getElementById('locationLng').value = '';
            
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }
            
            map.setView([defaultLat, defaultLng], 13);
            showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©', 'info');
        }

        async function getMyLocation() {
            const btn = document.querySelector('button[onclick="getMyLocation()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©...';
            btn.disabled = true;
            
            // Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØªØ¨Ø¹ Ø£ÙØ¶Ù„ Ù…ÙˆÙ‚Ø¹
            let bestLocation = null;
            let watchId = null;
            
            try {
                // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø³Ù‘Ù† (Best Fix Strategy)
                const getBestLocation = new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'));
                        return;
                    }

                    // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù†Ø¹Ø·ÙŠ ÙˆÙ‚ØªØ§Ù‹ Ø£Ø·ÙˆÙ„: 15 Ø«Ø§Ù†ÙŠØ©)
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const newLoc = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                type: 'gps'
                            };

                            // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø© (Ø£Ù‚Ù„ Ù…Ù† 30 Ù…ØªØ±)ØŒ Ù†ÙƒØªÙÙŠ Ø¨Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
                            if (newLoc.accuracy <= 30) {
                                resolve(newLoc);
                                return;
                            }

                            // Ø­ÙØ¸ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù†ØµÙ„ Ø¥Ù„ÙŠÙ‡Ø§
                            if (!bestLocation || newLoc.accuracy < bestLocation.accuracy) {
                                bestLocation = newLoc;
                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø±
                                btn.innerHTML = `â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø³ÙŠÙ† (${Math.round(newLoc.accuracy)}Ù…)...`;
                            }
                        },
                        (error) => {
                            console.warn(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        }
                    );

                    // Ù†Ù†ØªØ¸Ø± 15 Ø«Ø§Ù†ÙŠØ© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯Ù‚Ø© Ø£Ù‚Ù„ Ù…Ù† 600Ù…
                    setTimeout(() => {
                        if (bestLocation) {
                            resolve(bestLocation);
                        } else {
                            reject(new Error('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©'));
                        }
                    }, 15000);
                });

                // ØªÙ†ÙÙŠØ°
                let location;
                try {
                    location = await getBestLocation;
                } catch (gpsError) {
                    console.warn("GPS timeout/error, trying IP...", gpsError);
                    location = await getIPLocation();
                } finally {
                    if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                }

                // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const acc = Math.round(location.accuracy);
                currentLocationAccuracy = acc; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                
                // ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¯Ù‚Ø©
                if (accuracyCircle) map.removeLayer(accuracyCircle);
                let color = acc <= 50 ? '#10b981' : (acc <= 800 ? '#f59e0b' : '#ef4444');
                
                accuracyCircle = L.circle([location.lat, location.lng], {
                    radius: acc,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);

                // 4. Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø©
                if (acc <= 800) {
                    // Ø¯Ù‚Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©
                    setMapLocation(location.lat, location.lng, true); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ inputs
                    
                    if (acc <= 50) {
                        showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø© (${acc} Ù…ØªØ±)`, 'success');
                    } else {
                        showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø© ${acc} Ù…ØªØ±.`, 'info');
                    }
                    
                    if (acc > 30 && acc < 5000) map.fitBounds(accuracyCircle.getBounds());
                    else map.setView([location.lat, location.lng], 16);
                    
                } else {
                    // Ø¯Ù‚Ø© Ø³ÙŠØ¦Ø© (> 800 Ù…ØªØ±)
                    // Ù†Ø¶Ø¹ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ù„ÙƒÙ†Ù†Ø§ Ù„Ù† "Ù†Ø¹ØªÙ…Ø¯" Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ (Ù„Ø£Ù† currentLocationAccuracy > 800)
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³ÙŠØ¶Ø·Ø± Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ù„Ø¬Ø¹Ù„Ù‡ 0 (Ø¯Ù‚ÙŠÙ‚)
                    
                    setMapLocation(location.lat, location.lng, true); // Ù†Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ù„ÙƒÙŠ ÙŠØ±Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙƒØ§Ù†Ù‡
                    map.setView([location.lat, location.lng], 15);
                    
                    showToast(`âš ï¸ Ø§Ù„Ø¯Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹ (${acc}Ù…). ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ØŒ Ø£Ùˆ Ù‚Ù… Ø¨ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¯Ø¨ÙˆØ³ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©.`, 'error', 8000);
                }

            } catch (error) {
                 showToast('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹.', 'error');
                 console.error(error);
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function handleCheckout(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            const address = document.getElementById('address').value.trim(); // Optional now
            const notes = document.getElementById('notes').value.trim();
            
            if (!validatePhone(customerPhone)) {
                showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                return;
            }
            
            if (orderType === 'delivery') {
                // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)
                if (!document.getElementById('locationLat').value) {
                     showToast('âš ï¸ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨', 'error');
                     // Ù…Ø­Ø§ÙˆÙ„Ø© Ù„ÙØª Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ Ù„Ù„Ø®Ø±ÙŠØ·Ø©
                     document.getElementById('mapContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
                     return;
                }

                // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ù‚Ø© (< 800 Ù…ØªØ±)
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª currentLocationAccuracy ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† 800
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙŠØ¬Ø¹Ù„Ù‡Ø§ 0ØŒ Ù„Ø°Ø§ Ø³ÙŠÙ…Ø±.
                if (currentLocationAccuracy === null || currentLocationAccuracy > 800) {
                     showToast(`âš ï¸ Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø³ÙŠØ¦Ø© (${currentLocationAccuracy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}Ù…). ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙ„ÙŠØ³ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ØŒ Ø£Ùˆ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ Ù…Ù†Ø²Ù„Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`, 'error', 8000);
                     return;
                }
            }
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
            btn.disabled = true;
            
            const orderData = {
                customerName,
                customerPhone,
                orderType,
                address: address, // Optional
                location: document.getElementById('locationLat').value ? {
                    lat: parseFloat(document.getElementById('locationLat').value),
                    lng: parseFloat(document.getElementById('locationLng').value)
                } : null,
                scheduledTime: null,
                notes
            };
            
            try {
                const order = await createOrder(orderData);
                
                if (order) {
                    sessionStorage.setItem('lastOrderNumber', order.orderNumber || order.id);
                    sessionStorage.setItem('lastOrderId', order.id);
                    // Save full object to avoid fetch race conditions
                    sessionStorage.setItem('lastOrderDetails', JSON.stringify(order));
                    window.location.replace('order-success.html');
                } else {
                     throw new Error("Order creation failed");
                }
            } catch (err) {
                console.error("Checkout Error:", err);
                let msg = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                
                // Specific Translations
                if (err.message === 'Restaurant is closed') msg = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù…Ø·Ø¹Ù… Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹';
                else if (err.message === 'Cart is empty') msg = 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©';
                else if (err.message && !err.message.startsWith('API Error') && err.message !== 'Order creation failed') {
                    // Show backend error (likely validation)
                    msg = err.message;
                }
                
                showToast(msg, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
    
    <style>
        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 2rem;
        }
        
        .checkout-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }
        
        .map-container {
            height: 320px;
            border-radius: var(--radius-lg);
            margin-bottom: 1.25rem;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        
        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            max-height: 280px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-xl);
        }
        
        .search-result-item {
            padding: 0.85rem 1.25rem;
            cursor: pointer;
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.2s ease;
        }
        
        .search-result-item:hover {
            background: var(--glass-hover);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .distance-badge {
            font-size: 0.8rem;
            color: var(--primary-light);
            font-weight: 600;
        }
        
        .search-loading,
        .search-empty,
        .search-error {
            padding: 1.25rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .search-error {
            color: var(--danger);
        }
        
        .selected-location-card {
            display: none;
            padding: 1rem 1.25rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-lg);
            margin-bottom: 1.25rem;
            border: 1px solid var(--accent);
        }
        
        .checkout-item {
            display: flex;
            justify-content: space-between;
            padding: 0.85rem 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .checkout-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 900px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }
            .cart-summary {
                position: static !important;
            }
        }
        .map-loading-overlay {
            position: absolute;
            inset: 0;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
    </style>
    
    <style>
        /* Enhanced Typography & UI */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        
        .checkout-section, input, textarea, button, select, .form-label, .section-title {
            font-family: 'Tajawal', system-ui, -apple-system, sans-serif !important;
        }

        .section-title {
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--text-main);
            letter-spacing: -0.02em;
        }

        .form-label {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-input, .form-textarea {
            font-size: 1rem;
            font-weight: 500;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            width: 100%;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.7);
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
            background: #fff;
            outline: none;
        }

        .btn {
            font-weight: 700;
            letter-spacing: 0.01em;
            padding: 12px 24px;
        }
        
        /* Map Markers Popup Font */
        .leaflet-popup-content {
            font-family: 'Tajawal', sans-serif !important;
            font-weight: 600;
        }
    </style>
</body>
</html>
